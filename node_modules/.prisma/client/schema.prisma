datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

enum TripStatus {
  ideia
  planejada
  em_andamento
  concluida
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  createdTrips Trip[]       @relation("TripCreatedBy")
  memberships  TripMember[]

  uploadedAtts Attachment[] @relation("AttachmentUploadedBy")
}

model Trip {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TripStatus @default(ideia)

  startDate DateTime?
  endDate   DateTime?

  createdBy   User   @relation("TripCreatedBy", fields: [createdById], references: [id])
  createdById String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  days Day[]

  checklist CheckItem[]

  members TripMember[]

  accessCodes AccessCode[]

  attachments Attachment[]
}

model Day {
  id   String @id @default(cuid())
  trip Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  tripId String

  title      String?
  from       String?
  to         String?
  distanceKm Float?
  eta        String?

  notes String?

  order Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  segments Segment[]

  attachments Attachment[]
}

model Segment {
  id    String @id @default(cuid())
  day   Day    @relation(fields: [dayId], references: [id], onDelete: Cascade)
  dayId String

  from       String
  to         String
  distanceKm Float?
  eta        String?

  order Int

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CheckItem {
  id     String @id @default(cuid())
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId String

  label String
  done  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AccessCode {
  id     String @id @default(cuid())
  code   String @unique
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId String

  role      String
  expiresAt DateTime?

  maxUses   Int?
  usedCount Int  @default(0)

  createdAt DateTime @default(now())
}

model TripMember {
  id        String   @id @default(cuid())
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId    String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  role      String
  createdAt DateTime @default(now())

  @@unique([tripId, userId])
}

model Attachment {
  id String @id @default(cuid())

  trip   Trip?   @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripId String?

  day   Day?    @relation(fields: [dayId], references: [id], onDelete: Cascade)
  dayId String?

  uploadedBy   User?   @relation("AttachmentUploadedBy", fields: [uploadedById], references: [id])
  uploadedById String?

  url      String
  filename String?
  mimeType String?
  note     String?

  createdAt DateTime @default(now())
}
